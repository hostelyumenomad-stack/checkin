<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .lang-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            flex-wrap: wrap;
        }

        .lang-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .lang-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .lang-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .content {
            padding: 30px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 2;
            position: relative;
        }

        .step.active {
            background: #667eea;
            color: white;
        }

        .step-line {
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required {
            color: #e74c3c;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .camera-section {
            margin: 20px 0;
        }

        .camera-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .camera-btn {
            padding: 15px;
            border: 2px dashed #667eea;
            background: #f8f9ff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .camera-btn:hover {
            background: #e8edff;
            transform: translateY(-2px);
        }

        video, .preview-image {
            width: 100%;
            border-radius: 10px;
            margin: 10px 0;
        }

        .success-screen {
            text-align: center;
            padding: 60px 30px;
        }

        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .success-screen h2 {
            font-size: 28px;
            color: #27ae60;
            margin-bottom: 10px;
        }

        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="title">ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h1>
            <p id="subtitle">ã‚ˆã†ã“ãï¼</p>
        </div>

        <div class="lang-selector">
            <button class="lang-btn active" onclick="changeLanguage('ja')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
            <button class="lang-btn" onclick="changeLanguage('en')">ğŸ‡¬ğŸ‡§ English</button>
            <button class="lang-btn" onclick="changeLanguage('zh')">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
            <button class="lang-btn" onclick="changeLanguage('ko')">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
            <button class="lang-btn" onclick="changeLanguage('vi')">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
        </div>

        <div class="content" id="mainContent">
            <div class="step-indicator">
                <div class="step-line"></div>
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">3</div>
            </div>

            <form id="checkinForm">
                <div id="stepContent1">
                    <div class="note" id="langNote">å³ä¸Šã®è¨€èªãƒœã‚¿ãƒ³ã‹ã‚‰ã€ã”å¸Œæœ›ã®è¨€èªã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                    
                    <div class="form-group">
                        <label id="labelName">ãŠåå‰ <span class="required">*</span></label>
                        <input type="text" id="name" placeholder="å±±ç”° å¤ªéƒ">
                        <div class="error hidden" id="errorName"></div>
                    </div>

                    <div class="form-group">
                        <label id="labelNationality">å›½ç± <span class="required">*</span></label>
                        <input type="text" id="nationality" placeholder="ä¾‹ï¼šæ—¥æœ¬ã€ã‚¢ãƒ¡ãƒªã‚«ã€ä¸­å›½...">
                        <div class="error hidden" id="errorNationality"></div>
                    </div>

                    <div class="form-group">
                        <label id="labelNights">å®¿æ³Šæ—¥æ•° <span class="required">*</span></label>
                        <input type="number" id="nights" value="1" min="1">
                    </div>
                </div>

                <div id="stepContent2" class="hidden">
                    <div class="form-group">
                        <label id="labelPhone">é›»è©±ç•ªå· <span class="required">*</span></label>
                        <input type="tel" id="phone" placeholder="090-1234-5678">
                        <div class="error hidden" id="errorPhone"></div>
                    </div>

                    <div class="form-group">
                        <label id="labelAddress">ã”ä½æ‰€</label>
                        <input type="text" id="address" placeholder="æ±äº¬éƒ½æ¸‹è°·åŒº...">
                    </div>

                    <div id="foreignFields" class="hidden">
                        <div class="note" style="background: #e3f2fd; border-left-color: #2196f3;">
                            â„¹ï¸ <span id="foreignOnlyNote">â€»æ—¥æœ¬äººã®æ–¹ã¯ã€ä»¥ä¸‹ã®å…¥åŠ›ã¯ä¸è¦ã§ã™</span>
                        </div>
                        
                        <div class="form-group">
                            <label id="labelDocType">èº«åˆ†è¨¼æ˜æ›¸ã®ç¨®é¡</label>
                            <select id="documentType">
                                <option value="passport">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</option>
                                <option value="residenceCard">åœ¨ç•™ã‚«ãƒ¼ãƒ‰</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label id="labelPassport">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·</label>
                            <input type="text" id="passportNumber" placeholder="AB1234567">
                        </div>
                    </div>
                </div>

                <div id="stepContent3" class="hidden">
                    <div id="japaneseNote" class="note hidden" style="background: #e8f5e9; border-left-color: #4caf50;">
                        âœ… <strong>æ—¥æœ¬äººã®æ–¹ã¸</strong><br>
                        èº«åˆ†è¨¼æ˜æ›¸ã®å†™çœŸæ’®å½±ã¯ä¸è¦ã§ã™ã€‚ã€Œãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                    </div>

                    <div id="photoSection" class="hidden">
                        <div class="note" style="background: #fff3e0; border-left-color: #ff9800; margin-bottom: 15px;">
                            âš ï¸ <strong>å¤–å›½ç±ã®æ–¹ã®ã¿</strong><br>
                            <span id="photoRequiredNote">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¾ãŸã¯åœ¨ç•™ã‚«ãƒ¼ãƒ‰ã®å†™çœŸãŒå¿…è¦ã§ã™</span>
                        </div>
                        
                        <div class="form-group">
                            <label id="labelPhoto">èº«åˆ†è¨¼æ˜æ›¸ã®å†™çœŸ <span class="required">*</span></label>
                            
                            <div class="camera-buttons" id="cameraButtons">
                                <div class="camera-btn" onclick="startCamera()">
                                    ğŸ“·<br><span id="btnCamera">ã‚«ãƒ¡ãƒ©ã§æ’®å½±</span>
                                </div>
                                <div class="camera-btn" onclick="document.getElementById('fileInput').click()">
                                    ğŸ“<br><span id="btnFile">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ</span>
                                </div>
                            </div>

                            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                            
                            <video id="video" class="hidden" autoplay playsinline></video>
                            <button type="button" id="captureBtn" class="btn-primary hidden" onclick="capturePhoto()">ğŸ“¸ æ’®å½±</button>
                            
                            <img id="preview" class="preview-image hidden">
                            <button type="button" id="retakeBtn" class="btn-secondary hidden" onclick="retakePhoto()">ğŸ”„ æ’®ã‚Šç›´ã—</button>
                            
                            <div class="error hidden" id="errorPhoto"></div>
                        </div>
                    </div>

                    <canvas id="canvas" class="hidden"></canvas>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn-secondary hidden" id="backBtn" onclick="previousStep()">
                        â† <span id="btnBack">æˆ»ã‚‹</span>
                    </button>
                    <button type="button" class="btn-primary" id="nextBtn" onclick="nextStep()">
                        <span id="btnNext">æ¬¡ã¸</span> â†’
                    </button>
                    <button type="button" class="btn-success hidden" id="submitBtn" onclick="submitForm()">
                        âœ“ <span id="btnSubmit">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†</span>
                    </button>
                </div>
            </form>
        </div>

        <div class="success-screen hidden" id="successScreen">
            <div class="success-icon">âœ…</div>
            <h2 id="successTitle">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†ï¼</h2>
            <p id="successMessage">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</p>
        </div>
    </div>

    <script>
        // ========================================
        // è¨­å®šï¼šGoogle Apps Scriptã®URL
        // ========================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxXCGLueSM9KbpiFpLKYGfC7zAoYcVQuu9TtAwvWyEhjH7faMZNf45y2ZOvxgIGvQG0/exec';
        
        // ========================================
        // ç¿»è¨³ãƒ‡ãƒ¼ã‚¿
        // ========================================
        const translations = {
            ja: {
                title: 'ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³',
                subtitle: 'ã‚ˆã†ã“ãï¼',
                langNote: 'å³ä¸Šã®è¨€èªãƒœã‚¿ãƒ³ã‹ã‚‰ã€ã”å¸Œæœ›ã®è¨€èªã‚’é¸æŠã—ã¦ãã ã•ã„',
                labelName: 'ãŠåå‰',
                labelNationality: 'å›½ç±',
                labelNights: 'å®¿æ³Šæ—¥æ•°',
                labelPhone: 'é›»è©±ç•ªå·',
                labelAddress: 'ã”ä½æ‰€',
                labelDocType: 'èº«åˆ†è¨¼æ˜æ›¸ã®ç¨®é¡',
                labelPassport: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·',
                labelPhoto: 'èº«åˆ†è¨¼æ˜æ›¸ã®å†™çœŸ',
                btnCamera: 'ã‚«ãƒ¡ãƒ©ã§æ’®å½±',
                btnFile: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ',
                btnBack: 'æˆ»ã‚‹',
                btnNext: 'æ¬¡ã¸',
                btnSubmit: 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†',
                successTitle: 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†ï¼',
                successMessage: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ',
                japaneseNote: 'â€»æ—¥æœ¬äººã®æ–¹ã¯ã€èº«åˆ†è¨¼æ˜æ›¸ã®å†™çœŸã¯ä¸è¦ã§ã™',
                required: 'å¿…é ˆé …ç›®ã§ã™',
                photoRequired: 'å†™çœŸãŒå¿…è¦ã§ã™'
            },
            en: {
                title: 'Self Check-in',
                subtitle: 'Welcome!',
                langNote: 'Please select your preferred language from the buttons above',
                labelName: 'Full Name',
                labelNationality: 'Nationality',
                labelNights: 'Number of Nights',
                labelPhone: 'Phone Number',
                labelAddress: 'Address',
                labelDocType: 'ID Type',
                labelPassport: 'Passport Number',
                labelPhoto: 'ID Photo',
                btnCamera: 'Take Photo',
                btnFile: 'Choose File',
                btnBack: 'Back',
                btnNext: 'Next',
                btnSubmit: 'Complete Check-in',
                successTitle: 'Check-in Complete!',
                successMessage: 'Thank you',
                japaneseNote: 'âœ… For Japanese Guests<br>ID photo is not required. Please click "Complete Check-in".',
                foreignOnlyNote: 'â„¹ï¸ Japanese guests: Fields below are not required',
                photoRequiredNote: 'Passport or Residence Card photo required',
                required: 'Required',
                photoRequired: 'Photo required'
            },
            zh: {
                title: 'è‡ªåŠ©å…¥ä½',
                subtitle: 'æ¬¢è¿å…‰ä¸´ï¼',
                langNote: 'è¯·ä»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©æ‚¨çš„è¯­è¨€',
                labelName: 'å§“å',
                labelNationality: 'å›½ç±',
                labelNights: 'ä½å®¿å¤©æ•°',
                labelPhone: 'ç”µè¯å·ç ',
                labelAddress: 'åœ°å€',
                labelDocType: 'è¯ä»¶ç±»å‹',
                labelPassport: 'æŠ¤ç…§å·ç ',
                labelPhoto: 'è¯ä»¶ç…§ç‰‡',
                btnCamera: 'æ‹ç…§',
                btnFile: 'é€‰æ‹©æ–‡ä»¶',
                btnBack: 'è¿”å›',
                btnNext: 'ä¸‹ä¸€æ­¥',
                btnSubmit: 'å®Œæˆå…¥ä½',
                successTitle: 'å…¥ä½å®Œæˆï¼',
                successMessage: 'è°¢è°¢',
                japaneseNote: 'â€»æ—¥æœ¬å®¢äººæ— éœ€è¯ä»¶ç…§ç‰‡',
                required: 'å¿…å¡«é¡¹',
                photoRequired: 'éœ€è¦ç…§ç‰‡'
            },
            ko: {
                title: 'ì…€í”„ ì²´í¬ì¸',
                subtitle: 'í™˜ì˜í•©ë‹ˆë‹¤ï¼',
                langNote: 'ìœ„ ë²„íŠ¼ì—ì„œ ì›í•˜ëŠ” ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”',
                labelName: 'ì´ë¦„',
                labelNationality: 'êµ­ì ',
                labelNights: 'ìˆ™ë°• ì¼ìˆ˜',
                labelPhone: 'ì „í™”ë²ˆí˜¸',
                labelAddress: 'ì£¼ì†Œ',
                labelDocType: 'ì‹ ë¶„ì¦ ì¢…ë¥˜',
                labelPassport: 'ì—¬ê¶Œ ë²ˆí˜¸',
                labelPhoto: 'ì‹ ë¶„ì¦ ì‚¬ì§„',
                btnCamera: 'ì‚¬ì§„ ì´¬ì˜',
                btnFile: 'íŒŒì¼ ì„ íƒ',
                btnBack: 'ì´ì „',
                btnNext: 'ë‹¤ìŒ',
                btnSubmit: 'ì²´í¬ì¸ ì™„ë£Œ',
                successTitle: 'ì²´í¬ì¸ ì™„ë£Œï¼',
                successMessage: 'ê°ì‚¬í•©ë‹ˆë‹¤',
                japaneseNote: 'â€»ì¼ë³¸ì¸ ê³ ê°ì€ ì‹ ë¶„ì¦ ì‚¬ì§„ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤',
                required: 'í•„ìˆ˜ í•­ëª©',
                photoRequired: 'ì‚¬ì§„ í•„ìš”'
            },
            vi: {
                title: 'Tá»± ÄÄƒng KÃ½',
                subtitle: 'ChÃ o má»«ngï¼',
                langNote: 'Vui lÃ²ng chá»n ngÃ´n ngá»¯ tá»« cÃ¡c nÃºt á»Ÿ trÃªn',
                labelName: 'Há» vÃ  TÃªn',
                labelNationality: 'Quá»‘c tá»‹ch',
                labelNights: 'Sá»‘ Ä‘Ãªm',
                labelPhone: 'Sá»‘ Ä‘iá»‡n thoáº¡i',
                labelAddress: 'Äá»‹a chá»‰',
                labelDocType: 'Loáº¡i giáº¥y tá»',
                labelPassport: 'Sá»‘ há»™ chiáº¿u',
                labelPhoto: 'áº¢nh giáº¥y tá»',
                btnCamera: 'Chá»¥p áº£nh',
                btnFile: 'Chá»n file',
                btnBack: 'Quay láº¡i',
                btnNext: 'Tiáº¿p theo',
                btnSubmit: 'HoÃ n táº¥t',
                successTitle: 'ÄÄƒng kÃ½ hoÃ n táº¥tï¼',
                successMessage: 'Cáº£m Æ¡n',
                japaneseNote: 'â€»KhÃ¡ch Nháº­t khÃ´ng cáº§n áº£nh giáº¥y tá»',
                required: 'Báº¯t buá»™c',
                photoRequired: 'Cáº§n áº£nh'
            }
        };

        let currentStep = 1;
        let currentLanguage = 'ja';
        let videoStream = null;
        let capturedImage = null;

        function changeLanguage(lang) {
            currentLanguage = lang;
            const t = translations[lang];

            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('title').textContent = t.title;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('langNote').textContent = t.langNote;
            document.getElementById('labelName').innerHTML = t.labelName + ' <span class="required">*</span>';
            document.getElementById('labelNationality').innerHTML = t.labelNationality + ' <span class="required">*</span>';
            document.getElementById('labelNights').innerHTML = t.labelNights + ' <span class="required">*</span>';
            document.getElementById('labelPhone').innerHTML = t.labelPhone + ' <span class="required">*</span>';
            document.getElementById('labelAddress').textContent = t.labelAddress;
            document.getElementById('labelDocType').textContent = t.labelDocType;
            document.getElementById('labelPassport').textContent = t.labelPassport;
            document.getElementById('labelPhoto').innerHTML = t.labelPhoto + ' <span class="required">*</span>';
            document.getElementById('btnCamera').textContent = t.btnCamera;
            document.getElementById('btnFile').textContent = t.btnFile;
            document.getElementById('btnBack').textContent = t.btnBack;
            document.getElementById('btnNext').textContent = t.btnNext;
            document.getElementById('btnSubmit').textContent = t.btnSubmit;
            document.getElementById('successTitle').textContent = t.successTitle;
            document.getElementById('successMessage').textContent = t.successMessage;
            document.getElementById('japaneseNote').innerHTML = t.japaneseNote;
            
            if (document.getElementById('foreignOnlyNote')) {
                document.getElementById('foreignOnlyNote').textContent = t.foreignOnlyNote || 'â€»æ—¥æœ¬äººã®æ–¹ã¯ã€ä»¥ä¸‹ã®å…¥åŠ›ã¯ä¸è¦ã§ã™';
            }
            if (document.getElementById('photoRequiredNote')) {
                document.getElementById('photoRequiredNote').textContent = t.photoRequiredNote || 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¾ãŸã¯åœ¨ç•™ã‚«ãƒ¼ãƒ‰ã®å†™çœŸãŒå¿…è¦ã§ã™';
            }
        }

        function isJapanese() {
            const nat = document.getElementById('nationality').value.toLowerCase().trim();
            return nat === 'æ—¥æœ¬' || nat === 'japan' || nat === 'ì¼ë³¸' || 
                   nat === 'nháº­t báº£n' || nat === 'ã«ã»ã‚“' || nat === 'ã«ã£ã½ã‚“';
        }

        function nextStep() {
            if (validateCurrentStep()) {
                currentStep++;
                updateStepDisplay();
            }
        }

        function previousStep() {
            currentStep--;
            updateStepDisplay();
        }

        function updateStepDisplay() {
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                const contentEl = document.getElementById(`stepContent${i}`);
                
                if (i <= currentStep) {
                    stepEl.classList.add('active');
                } else {
                    stepEl.classList.remove('active');
                }
                
                if (i === currentStep) {
                    contentEl.classList.remove('hidden');
                } else {
                    contentEl.classList.add('hidden');
                }
            }

            document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 3);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== 3);

            if (currentStep === 2) {
                const foreignFields = document.getElementById('foreignFields');
                foreignFields.classList.toggle('hidden', isJapanese());
            }

            if (currentStep === 3) {
                const photoSection = document.getElementById('photoSection');
                const japaneseNote = document.getElementById('japaneseNote');
                
                if (isJapanese()) {
                    photoSection.classList.add('hidden');
                    japaneseNote.classList.remove('hidden');
                } else {
                    photoSection.classList.remove('hidden');
                    japaneseNote.classList.add('hidden');
                }
            }
        }

        function validateCurrentStep() {
            const t = translations[currentLanguage];
            let isValid = true;

            if (currentStep === 1) {
                const name = document.getElementById('name').value.trim();
                const nationality = document.getElementById('nationality').value.trim();
                
                if (!name) {
                    showError('errorName', t.required);
                    isValid = false;
                }
                
                if (!nationality) {
                    showError('errorNationality', t.required);
                    isValid = false;
                }
            }

            if (currentStep === 2) {
                const phone = document.getElementById('phone').value.trim();
                
                if (!phone) {
                    showError('errorPhone', t.required);
                    isValid = false;
                }
            }

            if (currentStep === 3 && !isJapanese()) {
                if (!capturedImage) {
                    showError('errorPhoto', t.photoRequired);
                    isValid = false;
                }
            }

            return isValid;
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        document.getElementById('name').addEventListener('input', () => hideError('errorName'));
        document.getElementById('nationality').addEventListener('input', () => hideError('errorNationality'));
        document.getElementById('phone').addEventListener('input', () => hideError('errorPhone'));

        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                
                document.getElementById('cameraButtons').classList.add('hidden');
                video.classList.remove('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
            } catch (err) {
                alert('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('preview');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            capturedImage = canvas.toDataURL('image/jpeg', 0.7);
            
            preview.src = capturedImage;
            preview.classList.remove('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            
            video.classList.add('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            
            stopCamera();
            hideError('errorPhoto');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    capturedImage = e.target.result;
                    const preview = document.getElementById('preview');
                    preview.src = capturedImage;
                    preview.classList.remove('hidden');
                    document.getElementById('retakeBtn').classList.remove('hidden');
                    document.getElementById('cameraButtons').classList.add('hidden');
                    hideError('errorPhoto');
                };
                reader.readAsDataURL(file);
            }
        }

        function retakePhoto() {
            capturedImage = null;
            document.getElementById('preview').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('cameraButtons').classList.remove('hidden');
        }

        async function submitForm() {
            if (!validateCurrentStep()) return;

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span> é€ä¿¡ä¸­...';

            const formData = {
                name: document.getElementById('name').value,
                nationality: document.getElementById('nationality').value,
                nights: document.getElementById('nights').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                documentType: document.getElementById('documentType').value,
                passportNumber: document.getElementById('passportNumber').value,
                documentImage: capturedImage,
                language: currentLanguage
            };

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('successScreen').classList.remove('hidden');
                
                setTimeout(() => {
                    location.reload();
                }, 3000);
                
            } catch (error) {
                alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
                submitBtn.disabled = false;
                const t = translations[currentLanguage];
                submitBtn.innerHTML = 'âœ“ ' + t.btnSubmit;
            }
        }
    </script>
</body>
</html>