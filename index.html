<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .lang-selector { display: flex; justify-content: center; gap: 10px; padding: 20px; background: #f8f9fa; flex-wrap: wrap; }
        .lang-btn { padding: 10px 20px; border: 2px solid #ddd; background: white; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .lang-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .content { padding: 30px; }
        .step-indicator { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .step { width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 2; position: relative; }
        .step.active { background: #667eea; color: white; }
        .step-line { position: absolute; top: 20px; left: 40px; right: 40px; height: 2px; background: #e0e0e0; z-index: 1; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .required { color: #e74c3c; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        .error { color: #e74c3c; font-size: 12px; margin-top: 5px; }
        .btn-group { display: flex; gap: 10px; margin-top: 30px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-success { background: #27ae60; color: white; }
        .note { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px; margin: 20px 0; font-size: 14px; }
        .warning-box { background: #fdeaea; border: 1px solid #ebccd1; color: #a94442; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; font-weight: bold; text-align: center; }
        .hidden { display: none; }
        video, .preview-image { width: 100%; border-radius: 10px; margin: 10px 0; }
        .camera-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .camera-btn { padding: 15px; border: 2px dashed #667eea; background: #f8f9ff; border-radius: 10px; cursor: pointer; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="title">ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h1>
            <p id="subtitle">ã‚ˆã†ã“ãï¼</p>
        </div>

        <div class="lang-selector">
            <button class="lang-btn active" onclick="changeLanguage('ja', this)">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
            <button class="lang-btn" onclick="changeLanguage('en', this)">ğŸ‡¬ğŸ‡§ English</button>
            <button class="lang-btn" onclick="changeLanguage('zh', this)">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
            <button class="lang-btn" onclick="changeLanguage('ko', this)">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
            <button class="lang-btn" onclick="changeLanguage('vi', this)">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
        </div>

        <div class="content" id="mainContent">
            <div class="step-indicator">
                <div class="step-line"></div>
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">3</div>
            </div>

            <form id="checkinForm">
                <div id="stepContent1">
                    <div class="warning-box hidden" id="warningInput1"></div>
                    <div class="form-group"><label id="labelName">ãŠåå‰ <span class="required">*</span></label><input type="text" id="name" placeholder="å±±ç”° å¤ªéƒ"><div class="error hidden" id="errorName"></div></div>
                    <div class="form-group"><label id="labelNationality">å›½ç± <span class="required">*</span></label><input type="text" id="nationality" placeholder="ä¾‹ï¼šæ—¥æœ¬ã€ã‚¢ãƒ¡ãƒªã‚«ã€ä¸­å›½..."><div class="error hidden" id="errorNationality"></div></div>
                    <div class="form-group"><label id="labelNights">å®¿æ³Šæ—¥æ•° <span class="required">*</span></label><input type="number" id="nights" value="1" min="1"></div>
                </div>

                <div id="stepContent2" class="hidden">
                    <div class="warning-box hidden" id="warningInput2"></div>
                    <div class="form-group"><label id="labelPhone">é›»è©±ç•ªå· <span class="required">*</span></label><input type="tel" id="phone" placeholder="090-1234-5678"><div class="error hidden" id="errorPhone"></div></div>
                    <div class="form-group"><label id="labelAddress">ã”ä½æ‰€ <span class="required">*</span></label><input type="text" id="address" placeholder="æ±äº¬éƒ½æ¸‹è°·åŒº..."><div class="error hidden" id="errorAddress"></div></div>
                    <div id="foreignFields" class="hidden">
                        <div class="note">â„¹ï¸ <span id="foreignOnlyNote">â€»æ—¥æœ¬äººã®æ–¹ã¯ã€ä»¥ä¸‹ã®å…¥åŠ›ã¯ä¸è¦ã§ã™</span></div>
                        <div class="form-group"><label id="labelDocType">èº«åˆ†è¨¼æ˜æ›¸ã®ç¨®é¡</label><select id="documentType"><option value="passport">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ / Passport</option><option value="residenceCard">åœ¨ç•™ã‚«ãƒ¼ãƒ‰ / Residence Card</option></select></div>
                        <div class="form-group"><label id="labelPassport">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå· <span class="required">*</span></label><input type="text" id="passportNumber" placeholder="AB1234567"><div class="error hidden" id="errorPassport"></div></div>
                    </div>
                </div>

                <div id="stepContent3" class="hidden">
                    <div id="japaneseNote" class="note hidden">âœ… <strong><span id="jpNoteTitle">æ—¥æœ¬äººã®æ–¹ã¸</span></strong><br><br><span id="jpNoteBody">èº«åˆ†è¨¼æ˜æ›¸ã®å†™çœŸæ’®å½±ã¯ä¸è¦ã§ã™ã€‚ã€Œãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span></div>
                    <div id="photoSection" class="hidden">
                        <div class="note" style="background: #fff3e0; border-left-color: #ff9800;">âš ï¸ <strong><span id="photoWarningTitle">å¤–å›½ç±ã®æ–¹ã®ã¿</span></strong><br><span id="photoRequiredNote">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¾ãŸã¯åœ¨ç•™ã‚«ãƒ¼ãƒ‰ã®å†™çœŸãŒå¿…è¦ã§ã™</span></div>
                        <div class="form-group">
                            <label id="labelPhoto">èº«åˆ†è¨¼æ˜æ›¸ã®å†™çœŸ <span class="required">*</span></label>
                            <div class="camera-buttons" id="cameraButtons">
                                <div class="camera-btn" onclick="startCamera()">ğŸ“·<br><span id="btnCamera">ã‚«ãƒ¡ãƒ©ã§æ’®å½±</span></div>
                                <div class="camera-btn" onclick="document.getElementById('fileInput').click()">ğŸ“<br><span id="btnFile">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ</span></div>
                            </div>
                            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                            <video id="video" class="hidden" autoplay playsinline></video>
                            <button type="button" id="captureBtn" class="btn-primary hidden" onclick="capturePhoto()">ğŸ“¸ æ’®å½±</button>
                            <img id="preview" class="preview-image hidden">
                            <button type="button" id="retakeBtn" class="btn-secondary hidden" onclick="retakePhoto()">ğŸ”„ <span id="btnRetake">æ’®ã‚Šç›´ã—</span></button>
                            <div class="error hidden" id="errorPhoto"></div>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn-secondary hidden" id="backBtn" onclick="previousStep()">â† <span id="btnBack">æˆ»ã‚‹</span></button>
                    <button type="button" class="btn-primary" id="nextBtn" onclick="nextStep()"><span id="btnNext">æ¬¡ã¸</span> â†’</button>
                    <button type="button" class="btn-success hidden" id="submitBtn" onclick="submitForm()">âœ“ <span id="btnSubmit">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†</span></button>
                </div>
            </form>
        </div>
        <div class="success-screen hidden" id="successScreen" style="padding:50px; text-align:center;"><h2>âœ… <span id="successTitle">å®Œäº† / Success</span></h2><p id="successMessage">æš—è¨¼ç•ªå·ã®ç”»é¢ã¸ç§»å‹•ã—ã¾ã™...<br>Redirecting to PIN page...</p></div>
    </div>

    <script>
        // è¨­å®š
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxXCGLueSM9KbpiFpLKYGfC7zAoYcVQuu9TtAwvWyEhjH7faMZNf45y2ZOvxgIGvQG0/exec';
        const STEP2_URL = 'https://script.google.com/macros/s/AKfycbw8ICsKHFHO99zSMplJxtlROmvoYI_bF2-H-QCZ2T1kG39COhN5dFPZRytVap0YdN7GJA/exec';

        const translations = {
            ja: { title: 'ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³', subtitle: 'ã‚ˆã†ã“ãï¼', warning: '', labelName: 'ãŠåå‰', phName: 'å±±ç”° å¤ªéƒ', labelNationality: 'å›½ç±', phNationality: 'ä¾‹ï¼šæ—¥æœ¬ã€ã‚¢ãƒ¡ãƒªã‚«ã€ä¸­å›½...', labelPhone: 'é›»è©±ç•ªå·', phPhone: '090-1234-5678', labelAddress: 'ã”ä½æ‰€', phAddress: 'æ±äº¬éƒ½æ¸‹è°·åŒº...', labelPassport: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·', phPassport: 'AB1234567', btnNext: 'æ¬¡ã¸', btnBack: 'æˆ»ã‚‹', btnSubmit: 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†', required: 'å¿…é ˆé …ç›®ã§ã™', jpNoteTitle: 'æ—¥æœ¬äººã®æ–¹ã¸', jpNoteBody: 'èº«åˆ†è¨¼æ˜æ›¸ã®å†™çœŸæ’®å½±ã¯ä¸è¦ã§ã™ã€‚ã€Œãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', photoWarningTitle: 'å¤–å›½ç±ã®æ–¹ã®ã¿', photoRequiredNote: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¾ãŸã¯åœ¨ç•™ã‚«ãƒ¼ãƒ‰ã®å†™çœŸãŒå¿…è¦ã§ã™', labelPhoto: 'èº«åˆ†è¨¼æ˜æ›¸ã®å†™çœŸ', btnCamera: 'ã‚«ãƒ¡ãƒ©ã§æ’®å½±', btnFile: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ', btnRetake: 'æ’®ã‚Šç›´ã—', foreignOnlyNote: 'â€»æ—¥æœ¬äººã®æ–¹ã¯ã€ä»¥ä¸‹ã®å…¥åŠ›ã¯ä¸è¦ã§ã™' },
            en: { title: 'Self Check-in', subtitle: 'Welcome!', warning: 'Please enter in English, or Japanese', labelName: 'Full Name', phName: 'Bob Marley', labelNationality: 'Nationality', phNationality: 'e.g. USA, UK, China...', labelPhone: 'Phone Number', phPhone: '+1-234-567-890', labelAddress: 'Address', phAddress: '1-1-1 Shibuya, Tokyo...', labelPassport: 'Passport Number', phPassport: 'AB1234567', btnNext: 'Next', btnBack: 'Back', btnSubmit: 'Complete Check-in', required: 'Required', jpNoteTitle: 'For Japanese Guests', jpNoteBody: 'Photo ID is not required for Japanese citizens. Please click "Complete Check-in".', photoWarningTitle: 'Foreign Guests Only', photoRequiredNote: 'A photo of your passport or residence card is required.', labelPhoto: 'Photo of ID', btnCamera: 'Take Photo', btnFile: 'Choose File', btnRetake: 'Retake', foreignOnlyNote: 'Japanese guests: Fields below are not required' },
            zh: { title: 'è‡ªåŠ©å…¥ä½', subtitle: 'æ¬¢è¿ï¼', warning: 'è¯·è¾“å…¥æ•°å­—ã€å­—æ¯æˆ–æ—¥è¯­', labelName: 'å§“å', phName: 'Bob Marley', labelNationality: 'å›½ç±', phNationality: 'ä¾‹å¦‚ï¼šä¸­å›½ã€ç¾å›½ã€æ—¥æœ¬...', labelPhone: 'ç”µè¯å·ç ', phPhone: '138-0000-0000', labelAddress: 'åœ°å€', phAddress: 'ä¸œäº¬éƒ½æ¶©è°·åŒº...', labelPassport: 'æŠ¤ç…§å·ç ', phPassport: 'AB1234567', btnNext: 'ä¸‹ä¸€æ­¥', btnBack: 'è¿”å›', btnSubmit: 'å®Œæˆå…¥ä½', required: 'å¿…å¡«é¡¹', jpNoteTitle: 'æ—¥æœ¬ç±å®¢äºº', jpNoteBody: 'æ—¥æœ¬å…¬æ°‘ä¸éœ€è¦èº«ä»½è¯ç…§ç‰‡ã€‚è¯·ç‚¹å‡»â€œå®Œæˆå…¥ä½â€ã€‚', photoWarningTitle: 'ä»…é™å¤–å›½ç±å®¢äºº', photoRequiredNote: 'éœ€è¦æŠ¤ç…§æˆ–åœ¨ç•™å¡çš„ç…§ç‰‡ã€‚', labelPhoto: 'èº«ä»½è¯ä»¶ç…§ç‰‡', btnCamera: 'æ‹ç…§', btnFile: 'é€‰æ‹©æ–‡ä»¶', btnRetake: 'é‡æ‹', foreignOnlyNote: 'æ—¥æœ¬å®¢äººï¼šä¸éœ€è¦å¡«å†™ä»¥ä¸‹å†…å®¹' },
            ko: { title: 'ì…€í”„ ì²´í¬ì¸', subtitle: 'í™˜ì˜í•©ë‹ˆë‹¤!', warning: 'ìˆ«ì, ì•ŒíŒŒë²³ ë˜ëŠ” ì¼ë³¸ì–´ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”', labelName: 'ì´ë¦„', phName: 'Bob Marley', labelNationality: 'êµ­ì ', phNationality: 'ì˜ˆ: í•œêµ­, ë¯¸êµ­, ì¼ë³¸...', labelPhone: 'ì „í™”ë²ˆí˜¸', phPhone: '010-1234-5678', labelAddress: 'ì£¼ì†Œ', phAddress: 'ë„ì¿„ë„ ì‹œë¶€ì•¼êµ¬...', labelPassport: 'ì—¬ê¶Œ ë²ˆå·', phPassport: 'AB1234567', btnNext: 'ë‹¤ìŒ', btnBack: 'ì´ì „', btnSubmit: 'ì²´í¬ã‚¤ãƒ³ ì™„ë£Œ', required: 'í•„ìˆ˜ í•­ëª©', jpNoteTitle: 'ì¼ë³¸ì¸ ê³ ê°ì˜ ê²½ìš°', jpNoteBody: 'ì¼ë³¸ ì‹œë¯¼ì€ ì‹ ë¶„ì¦ å†™çœŸì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. "ì²´í¬ì¸ ì™„ë£Œ"ë¥¼ í´ë¦­í•˜ì‹­ì‹œì˜¤.', photoWarningTitle: 'ì™¸êµ­ì¸ ê³ ê° ì „ìš©', photoRequiredNote: 'ì—¬ê¶Œ ë˜ëŠ” ì¬ë¥˜ ì¹´ë“œì˜ å†™çœŸì´ í•„ìš”í•©ë‹ˆë‹¤.', labelPhoto: 'ì‹ ë¶„ì¦ ì‚¬ì§„', btnCamera: 'ì‚¬ì§„ ì´¬ì˜', btnFile: 'íŒŒì¼ ì„ íƒ', btnRetake: 'ë‹¤ì‹œ ì´¬ì˜', foreignOnlyNote: 'ì¼ë³¸ì¸ ê³ ê°: ì•„ë˜ í•­ëª©ì€ ì…ë ¥í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤' },
            vi: { title: 'Tá»± check-in', subtitle: 'ChÃ o má»«ng!', warning: 'Vui lÃ²ng nháº­p báº±ng sá»‘, báº£ng chá»¯ cÃ¡i hoáº·c tiáº¿ng Nháº­t', labelName: 'Há» vÃ  TÃªn', phName: 'Bob Marley', labelNationality: 'Quá»‘c tá»‹ch', phNationality: 'VD: Viá»‡t Nam, Má»¹, Nháº­t Báº£n...', labelPhone: 'Sá»‘ Ä‘iá»‡n thoáº¡i', phPhone: '090-1234-5678', labelAddress: 'Äá»‹a chá»‰', phAddress: 'Tokyo-to, Shibuya-ku...', labelPassport: 'Sá»‘ há»™ chiáº¿u', phPassport: 'AB1234567', btnNext: 'Tiáº¿p theo', btnBack: 'Quay láº¡i', btnSubmit: 'HoÃ n táº¥t', required: 'Báº¯t buá»™c', jpNoteTitle: 'DÃ nh cho khÃ¡ch Nháº­t Báº£n', jpNoteBody: 'CÃ´ng dÃ¢n Nháº­t Báº£n khÃ´ng cáº§n áº£nh ID. Vui lÃ²ng nháº¥p vÃ o "HoÃ n táº¥t".', photoWarningTitle: 'Chá»‰ dÃ nh cho khÃ¡ch nÆ°á»›c ngoÃ i', photoRequiredNote: 'YÃªu cáº§u áº£nh há»™ chiáº¿u hoáº·c tháº» ngoáº¡i kiá»u.', labelPhoto: 'áº¢nh chá»¥p giáº¥y tá» tÃ¹y thÃ¢n', btnCamera: 'Chá»¥p áº£nh', btnFile: 'Chá»n tá»‡p', btnRetake: 'Chá»¥p láº¡i', foreignOnlyNote: 'KhÃ¡ch Nháº­t Báº£n: KhÃ´ng cáº§n Ä‘iá»n cÃ¡c má»¥c bÃªn dÆ°á»›i' }
        };

        let currentStep = 1;
        let currentLanguage = 'ja';
        let capturedImage = null;
        let videoStream = null;

        function changeLanguage(lang, btn) {
            currentLanguage = lang;
            const t = translations[lang];
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('title').textContent = t.title;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('labelName').innerHTML = t.labelName + ' <span class="required">*</span>';
            document.getElementById('name').placeholder = t.phName;
            document.getElementById('labelNationality').innerHTML = t.labelNationality + ' <span class="required">*</span>';
            document.getElementById('nationality').placeholder = t.phNationality;
            document.getElementById('labelPhone').innerHTML = t.labelPhone + ' <span class="required">*</span>';
            document.getElementById('phone').placeholder = t.phPhone;
            document.getElementById('labelAddress').innerHTML = t.labelAddress + ' <span class="required">*</span>';
            document.getElementById('address').placeholder = t.phAddress;
            document.getElementById('labelPassport').innerHTML = t.labelPassport + ' <span class="required">*</span>';
            document.getElementById('passportNumber').placeholder = t.phPassport;
            document.getElementById('labelPhoto').innerHTML = t.labelPhoto + ' <span class="required">*</span>';
            document.getElementById('btnNext').textContent = t.btnNext;
            document.getElementById('btnBack').textContent = t.btnBack;
            document.getElementById('btnSubmit').textContent = t.btnSubmit;
            document.getElementById('btnRetake').textContent = t.btnRetake;
            document.getElementById('foreignOnlyNote').textContent = t.foreignOnlyNote;
            document.getElementById('jpNoteTitle').textContent = t.jpNoteTitle;
            document.getElementById('jpNoteBody').textContent = t.jpNoteBody;
            document.getElementById('photoWarningTitle').textContent = t.photoWarningTitle;
            document.getElementById('photoRequiredNote').textContent = t.photoRequiredNote;
            document.getElementById('btnCamera').textContent = t.btnCamera;
            document.getElementById('btnFile').textContent = t.btnFile;
            const warn1 = document.getElementById('warningInput1');
            const warn2 = document.getElementById('warningInput2');
            if (lang === 'ja') { warn1.classList.add('hidden'); warn2.classList.add('hidden'); }
            else { warn1.textContent = t.warning; warn2.textContent = t.warning; warn1.classList.remove('hidden'); warn2.classList.remove('hidden'); }
            updateStepDisplay();
        }

        function isJapanese() {
            const nat = document.getElementById('nationality').value.toLowerCase().trim();
            const jpList = ['æ—¥æœ¬', 'japan', 'ì¼ë³¸', 'nháº­t báº£n', 'ã«ã»ã‚“', 'ã«ã£ã½ã‚“', 'jp'];
            return jpList.includes(nat);
        }

        function nextStep() { if (validateCurrentStep()) { currentStep++; updateStepDisplay(); } }
        function previousStep() { currentStep--; updateStepDisplay(); }

        function updateStepDisplay() {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).classList.toggle('active', i <= currentStep);
                document.getElementById(`stepContent${i}`).classList.toggle('hidden', i !== currentStep);
            }
            document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 3);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== 3);
            if (currentStep === 2) { document.getElementById('foreignFields').classList.toggle('hidden', isJapanese()); }
            if (currentStep === 3) {
                const isJp = isJapanese();
                document.getElementById('photoSection').classList.toggle('hidden', isJp);
                document.getElementById('japaneseNote').classList.toggle('hidden', !isJp);
            }
        }

        function validateCurrentStep() {
            const t = translations[currentLanguage];
            let isValid = true;
            document.querySelectorAll('.error').forEach(e => e.classList.add('hidden'));
            if (currentStep === 1) {
                if (!document.getElementById('name').value.trim()) { showError('errorName', t.required); isValid = false; }
                if (!document.getElementById('nationality').value.trim()) { showError('errorNationality', t.required); isValid = false; }
            }
            if (currentStep === 2) {
                if (!document.getElementById('phone').value.trim()) { showError('errorPhone', t.required); isValid = false; }
                if (!document.getElementById('address').value.trim()) { showError('errorAddress', t.required); isValid = false; }
                if (!isJapanese() && !document.getElementById('passportNumber').value.trim()) { showError('errorPassport', t.required); isValid = false; }
            }
            if (currentStep === 3 && !isJapanese() && !capturedImage) { showError('errorPhoto', t.required); isValid = false; }
            return isValid;
        }

        function showError(id, msg) { const el = document.getElementById(id); el.textContent = msg; el.classList.remove('hidden'); }

        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                document.getElementById('cameraButtons').classList.add('hidden');
                video.classList.remove('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
            } catch (err) { alert('Camera error: ' + err.message); }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            capturedImage = canvas.toDataURL('image/jpeg', 0.7);
            document.getElementById('preview').src = capturedImage;
            document.getElementById('preview').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            video.classList.add('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            if (videoStream) videoStream.getTracks().forEach(track => track.stop());
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    capturedImage = e.target.result;
                    document.getElementById('preview').src = capturedImage;
                    document.getElementById('preview').classList.remove('hidden');
                    document.getElementById('retakeBtn').classList.remove('hidden');
                    document.getElementById('cameraButtons').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function retakePhoto() {
            capturedImage = null;
            document.getElementById('preview').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('cameraButtons').classList.remove('hidden');
        }

        async function submitForm() {
            if (!validateCurrentStep()) return;
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = 'Sending...';
            const guestName = document.getElementById('name').value.trim();
            const formData = {
                name: guestName,
                nationality: document.getElementById('nationality').value,
                nights: document.getElementById('nights').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                documentType: document.getElementById('documentType').value,
                passportNumber: document.getElementById('passportNumber').value,
                documentImage: capturedImage,
                language: currentLanguage
            };
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(formData) });
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('successScreen').classList.remove('hidden');
                setTimeout(() => {
                    window.location.href = STEP2_URL + '?name=' + encodeURIComponent(guestName);
                }, 1500);
            } catch (error) {
                alert('Submit error: ' + error.message);
                btn.disabled = false;
                btn.textContent = translations[currentLanguage].btnSubmit;
            }
        }
    </script>
</body>
</html>
