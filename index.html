<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self Check-in</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .lang-selector { display: flex; justify-content: center; gap: 8px; padding: 15px; background: #f8f9fa; flex-wrap: wrap; border-bottom: 1px solid #eee; }
        .lang-btn { padding: 8px 12px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .lang-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .content { padding: 25px; }
        .step-indicator { display: flex; justify-content: space-between; margin-bottom: 25px; position: relative; }
        .step { width: 35px; height: 35px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 2; position: relative; color: #666; }
        .step.active { background: #667eea; color: white; }
        .step-line { position: absolute; top: 17px; left: 35px; right: 35px; height: 2px; background: #e0e0e0; z-index: 1; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; }
        .required { color: #e74c3c; margin-left: 2px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; outline: none; transition: border-color 0.2s; }
        input:focus { border-color: #667eea; }
        .error { color: #e74c3c; font-size: 12px; margin-top: 4px; font-weight: bold; }
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-success { background: #27ae60; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden { display: none !important; }
        .note { background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 5px; margin: 15px 0; font-size: 13px; color: #856404; }
        video, .preview-image { width: 100%; border-radius: 10px; margin: 10px 0; background: #000; display: block; }
        .camera-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .camera-btn { padding: 15px; border: 2px dashed #667eea; background: #f8f9ff; border-radius: 10px; cursor: pointer; text-align: center; font-size: 14px; color: #667eea; font-weight: 600; }
        .success-screen { padding: 60px 20px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="title">ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h1>
            <p id="subtitle">Self Check-in</p>
        </div>

        <div class="lang-selector">
            <button class="lang-btn active" onclick="changeLanguage('ja', this)">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
            <button class="lang-btn" onclick="changeLanguage('en', this)">ğŸ‡¬ğŸ‡§ English</button>
            <button class="lang-btn" onclick="changeLanguage('zh', this)">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
            <button class="lang-btn" onclick="changeLanguage('ko', this)">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
            <button class="lang-btn" onclick="changeLanguage('vi', this)">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
        </div>

        <div class="content" id="mainContent">
            <div class="step-indicator">
                <div class="step-line"></div>
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">3</div>
            </div>

            <form id="checkinForm" onsubmit="return false;">
                <!-- STEP 1: åŸºæœ¬æƒ…å ± -->
                <div id="stepContent1">
                    <div class="form-group">
                        <label id="labelName">ãŠåå‰</label>
                        <input type="text" id="name" placeholder="å±±ç”° å¤ªéƒ">
                        <div class="error hidden" id="errorName"></div>
                    </div>
                    <div class="form-group">
                        <label id="labelNationality">å›½ç±</label>
                        <input type="text" id="nationality" placeholder="ä¾‹: æ—¥æœ¬, Japan, ä¸­å›½...">
                        <div class="error hidden" id="errorNationality"></div>
                    </div>
                    <div class="form-group">
                        <label id="labelBirthdate">ç”Ÿå¹´æœˆæ—¥</label>
                        <input type="date" id="birthdate">
                        <div class="error hidden" id="errorBirthdate"></div>
                    </div>
                </div>

                <!-- STEP 2: é€£çµ¡å…ˆãƒ»å®¿æ³Šæƒ…å ± -->
                <div id="stepContent2" class="hidden">
                    <div class="form-group">
                        <label id="labelNights">å®¿æ³Šæ•°</label>
                        <input type="number" id="nights" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label id="labelPhone">é›»è©±ç•ªå·</label>
                        <input type="tel" id="phone" placeholder="090-1234-5678">
                        <div class="error hidden" id="errorPhone"></div>
                    </div>
                    <div class="form-group">
                        <label id="labelAddress">ä½æ‰€</label>
                        <input type="text" id="address" placeholder="æ±äº¬éƒ½æ¸‹è°·åŒº...">
                        <div class="error hidden" id="errorAddress"></div>
                    </div>
                </div>

                <!-- STEP 3: æœ¬äººç¢ºèª -->
                <div id="stepContent3" class="hidden">
                    <div id="foreignFields">
                        <div class="note">â„¹ï¸ <span id="noteId">å¤–å›½ç±ã®æ–¹ã¯ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç­‰ã®æ’®å½±ãŒå¿…è¦ã§ã™ã€‚</span></div>
                        <div class="form-group">
                            <label id="labelDocType">è¨¼æ˜æ›¸ã®ç¨®é¡</label>
                            <select id="documentType">
                                <option value="Passport">Passport</option>
                                <option value="Residence Card">Residence Card</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="labelPassport">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ/èº«åˆ†è¨¼ç•ªå·</label>
                            <input type="text" id="passportNumber" placeholder="AB1234567">
                            <div class="error hidden" id="errorPassport"></div>
                        </div>
                        <div class="form-group">
                            <label id="labelPhoto">èº«åˆ†è¨¼ã®å†™çœŸ</label>
                            <div class="camera-buttons" id="cameraButtons">
                                <div class="camera-btn" onclick="startCamera()">ğŸ“· <span id="btnCamera">Camera</span></div>
                                <div class="camera-btn" onclick="document.getElementById('fileInput').click()">ğŸ“ <span id="btnFile">File</span></div>
                            </div>
                            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                            <video id="video" class="hidden" autoplay playsinline></video>
                            <button type="button" id="captureBtn" class="btn-primary hidden" onclick="capturePhoto()">ğŸ“¸ Capture</button>
                            <img id="preview" class="preview-image hidden" alt="Preview">
                            <button type="button" id="retakeBtn" class="btn-secondary hidden" onclick="retakePhoto()">ğŸ”„ Retake</button>
                            <div class="error hidden" id="errorPhoto"></div>
                        </div>
                    </div>
                    <div id="japaneseNote" class="note hidden">
                        âœ… <span id="noteJp">æ—¥æœ¬äººã®æ–¹ã¯å†™çœŸæ’®å½±ä¸è¦ã§ã™ã€‚ã€Œãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn-secondary hidden" id="backBtn" onclick="previousStep()">â† <span id="btnBack">Back</span></button>
                    <button type="button" class="btn-primary" id="nextBtn" onclick="nextStep()"><span id="btnNext">Next</span> â†’</button>
                    <button type="button" class="btn-success hidden" id="submitBtn" onclick="submitForm()">âœ“ <span id="btnSubmit">Finish</span></button>
                </div>
            </form>
        </div>

        <div class="success-screen hidden" id="successScreen">
            <h2 style="color: #27ae60; margin-bottom: 20px;">âœ… Thank you!</h2>
            <p id="successMsg">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>å®Œäº†ç”»é¢ã¸ç§»å‹•ã—ã¾ã™...</p>
        </div>
    </div>

    <script>
        // è¨­å®š
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxqqDedpsTIbGdtXhVouI4se9ZsV07gR19onY1UjbDBHPE7ODEW_R_5zqBuMHgxZs2x/exec';
        const NEXT_PAGE_URL = 'https://script.google.com/macros/s/AKfycbwxIJmU0kZMeMhaUcp2QsCLHv74Eujg-c9H1vBKvDEgwZd_Tri4mb-hJcb69fDrID_-Sw/exec';

        const translations = {
            ja: {
                title: 'ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³', labelName: 'ãŠåå‰', labelNationality: 'å›½ç±', labelBirthdate: 'ç”Ÿå¹´æœˆæ—¥', labelNights: 'å®¿æ³Šæ•°', labelPhone: 'é›»è©±ç•ªå·', labelAddress: 'ä½æ‰€', labelDocType: 'è¨¼æ˜æ›¸ã®ç¨®é¡', labelPassport: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·', labelPhoto: 'èº«åˆ†è¨¼ã®å†™çœŸ', btnNext: 'æ¬¡ã¸', btnBack: 'æˆ»ã‚‹', btnSubmit: 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†', required: 'å¿…é ˆé …ç›®ã§ã™', noteId: 'å¤–å›½ç±ã®æ–¹ã¯èº«åˆ†è¨¼ã®æ’®å½±ãŒå¿…è¦ã§ã™ã€‚', noteJp: 'æ—¥æœ¬äººã®æ–¹ã¯å†™çœŸæ’®å½±ä¸è¦ã§ã™ã€‚ãã®ã¾ã¾å®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', btnCamera: 'ã‚«ãƒ¡ãƒ©', btnFile: 'ãƒ•ã‚¡ã‚¤ãƒ«'
            },
            en: {
                title: 'Self Check-in', labelName: 'Full Name', labelNationality: 'Nationality', labelBirthdate: 'Birthdate', labelNights: 'Nights', labelPhone: 'Phone Number', labelAddress: 'Address', labelDocType: 'Document Type', labelPassport: 'Passport Number', labelPhoto: 'ID Photo', btnNext: 'Next', btnBack: 'Back', btnSubmit: 'Complete', required: 'Required', noteId: 'Non-Japanese guests are required to take a photo of ID.', noteJp: 'Japanese citizens do not need an ID photo. Click "Complete".', btnCamera: 'Camera', btnFile: 'File'
            },
            zh: {
                title: 'è‡ªåŠ©å…¥ä½', labelName: 'å§“å', labelNationality: 'å›½ç±', labelBirthdate: 'å‡ºç”Ÿæ—¥æœŸ', labelNights: 'å…¥ä½æ™šæ•°', labelPhone: 'ç”µè¯å·ç ', labelAddress: 'åœ°å€', labelDocType: 'è¯ä»¶ç±»å‹', labelPassport: 'æŠ¤ç…§å·ç ', labelPhoto: 'è¯ä»¶ç…§ç‰‡', btnNext: 'ä¸‹ä¸€æ­¥', btnBack: 'è¿”å›', btnSubmit: 'å®Œæˆå…¥ä½', required: 'å¿…å¡«', noteId: 'å¤–å›½ç±æ—…å®¢éœ€è¦æ‹æ‘„è¯ä»¶ã€‚', noteJp: 'æ—¥æœ¬ç±æ—…å®¢æ— éœ€æ‹æ‘„ã€‚ç›´æ¥ç‚¹å‡»å®Œæˆã€‚', btnCamera: 'ç›¸æœº', btnFile: 'æ–‡ä»¶'
            },
            ko: {
                title: 'ì…€í”„ ì²´í¬ì¸', labelName: 'ì„±í•¨', labelNationality: 'êµ­ì ', labelBirthdate: 'ìƒë…„ì›”ì¼', labelNights: 'ìˆ™ë°• ì¼ìˆ˜', labelPhone: 'ì „í™”ë²ˆí˜¸', labelAddress: 'ì£¼ì†Œ', labelDocType: 'ì‹ ë¶„ì¦ ì¢…ë¥˜', labelPassport: 'ì—¬ê¶Œ ë²ˆí˜¸', labelPhoto: 'ì‹ ë¶„ì¦ ì‚¬ì§„', btnNext: 'ë‹¤ìŒ', btnBack: 'ì´ì „', btnSubmit: 'ì²´í¬ã‚¤ãƒ³ ì™„ë£Œ', required: 'í•„ìˆ˜ í•­ëª©', noteId: 'ì™¸êµ­ì¸ ê³ ê°ë‹˜ì€ ì‹ ë¶„ì¦ ì´¬ì˜ì´ í•„ìš”í•©ë‹ˆë‹¤.', noteJp: 'ì¼ë³¸ì¸ ê³ ê°ë‹˜ì€ ì´¬ì˜ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤. ì™„ë£Œë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.', btnCamera: 'ì¹´ë©”ë¼', btnFile: 'íŒŒì¼'
            },
            vi: {
                title: 'Tá»± check-in', labelName: 'Há» vÃ  tÃªn', labelNationality: 'Quá»‘c tá»‹ch', labelBirthdate: 'NgÃ y sinh', labelNights: 'Sá»‘ Ä‘Ãªm', labelPhone: 'Sá»‘ Ä‘iá»‡n thoáº¡i', labelAddress: 'Äá»‹a chá»‰', labelDocType: 'Loáº¡i giáº¥y tá»', labelPassport: 'Sá»‘ há»™ chiáº¿u', labelPhoto: 'áº¢nh ID', btnNext: 'Tiáº¿p theo', btnBack: 'Quay láº¡i', btnSubmit: 'HoÃ n táº¥t', required: 'Báº¯t buá»™c', noteId: 'KhÃ¡ch nÆ°á»›c ngoÃ i cáº§n chá»¥p áº£nh ID.', noteJp: 'KhÃ¡ch Nháº­t khÃ´ng cáº§n chá»¥p áº£nh. Nháº¥n HoÃ n táº¥t.', btnCamera: 'MÃ¡y áº£nh', btnFile: 'Tá»‡p'
            }
        };

        let currentStep = 1;
        let currentLanguage = 'ja';
        let capturedImage = null;
        let videoStream = null;

        function changeLanguage(lang, btn) {
            currentLanguage = lang;
            const t = translations[lang];
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.getElementById('title').textContent = t.title;
            const ids = ['labelName', 'labelNationality', 'labelBirthdate', 'labelNights', 'labelPhone', 'labelAddress', 'labelDocType', 'labelPassport', 'labelPhoto', 'btnNext', 'btnBack', 'btnSubmit', 'noteId', 'noteJp', 'btnCamera', 'btnFile'];
            
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id.startsWith('label')) {
                        el.innerHTML = `${t[id]} <span class="required">*</span>`;
                    } else if (el.tagName === 'SPAN') {
                        el.textContent = t[id];
                    } else {
                        el.textContent = t[id];
                    }
                }
            });
        }

        function isJapanese() {
            const val = document.getElementById('nationality').value.toLowerCase().trim();
            const jpList = ['æ—¥æœ¬', 'japan', 'ì¼ë³¸', 'nháº­t báº£n', 'ã«ã»ã‚“', 'ã«ã£ã½ã‚“', 'jp', 'japanese'];
            return jpList.includes(val);
        }

        function nextStep() {
            if (validateStep()) {
                currentStep++;
                updateStepDisplay();
            }
        }

        function previousStep() {
            currentStep--;
            updateStepDisplay();
        }

        function updateStepDisplay() {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).classList.toggle('active', i <= currentStep);
                document.getElementById(`stepContent${i}`).classList.toggle('hidden', i !== currentStep);
            }
            document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 3);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== 3);

            if (currentStep === 3) {
                const jp = isJapanese();
                document.getElementById('foreignFields').classList.toggle('hidden', jp);
                document.getElementById('japaneseNote').classList.toggle('hidden', !jp);
            }
        }

        function validateStep() {
            const t = translations[currentLanguage];
            document.querySelectorAll('.error').forEach(e => e.classList.add('hidden'));
            let valid = true;

            if (currentStep === 1) {
                if (!document.getElementById('name').value.trim()) { showError('errorName', t.required); valid = false; }
                if (!document.getElementById('nationality').value.trim()) { showError('errorNationality', t.required); valid = false; }
                if (!document.getElementById('birthdate').value) { showError('errorBirthdate', t.required); valid = false; }
            } else if (currentStep === 2) {
                if (!document.getElementById('phone').value.trim()) { showError('errorPhone', t.required); valid = false; }
                if (!document.getElementById('address').value.trim()) { showError('errorAddress', t.required); valid = false; }
            } else if (currentStep === 3 && !isJapanese()) {
                if (!document.getElementById('passportNumber').value.trim()) { showError('errorPassport', t.required); valid = false; }
                if (!capturedImage) { showError('errorPhoto', t.required); valid = false; }
            }
            return valid;
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                video.classList.remove('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
                document.getElementById('cameraButtons').classList.add('hidden');
                document.getElementById('errorPhoto').classList.add('hidden');
            } catch (err) {
                alert('Camera Error: Please allow camera access or use File upload.');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            // è§£åƒåº¦ã‚’ã‚ã‚‹ç¨‹åº¦æŠ‘ãˆã¦é€ä¿¡ã‚µã‚¤ã‚ºã‚’ç¯€ç´„
            const scale = 800 / Math.max(video.videoWidth, video.videoHeight);
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            capturedImage = canvas.toDataURL('image/jpeg', 0.7);
            
            document.getElementById('preview').src = capturedImage;
            document.getElementById('preview').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            video.classList.add('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            
            if (videoStream) {
                videoStream.getTracks().forEach(t => t.stop());
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    capturedImage = event.target.result;
                    document.getElementById('preview').src = capturedImage;
                    document.getElementById('preview').classList.remove('hidden');
                    document.getElementById('retakeBtn').classList.remove('hidden');
                    document.getElementById('cameraButtons').classList.add('hidden');
                    document.getElementById('errorPhoto').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function retakePhoto() {
            capturedImage = null;
            document.getElementById('preview').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('cameraButtons').classList.remove('hidden');
            document.getElementById('fileInput').value = "";
            const video = document.getElementById('video');
            video.classList.add('hidden');
        }

        async function submitForm() {
            if (!validateStep()) return;
            
            const btn = document.getElementById('submitBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "...";

            const payload = {
                name: document.getElementById('name').value,
                nationality: document.getElementById('nationality').value,
                birthdate: document.getElementById('birthdate').value,
                nights: document.getElementById('nights').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                documentType: document.getElementById('documentType').value,
                passportNumber: document.getElementById('passportNumber').value,
                documentImage: capturedImage,
                language: currentLanguage,
                timestamp: new Date().toISOString()
            };

            try {
                // Google Apps Scriptã¸POST
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // æˆåŠŸè¡¨ç¤º
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('successScreen').classList.remove('hidden');

                // 1.5ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                setTimeout(() => {
                    window.location.href = `${NEXT_PAGE_URL}?name=${encodeURIComponent(payload.name)}`;
                }, 1500);

            } catch (err) {
                console.error(err);
                alert('Submit Error. Please try again.');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // åˆæœŸè¨€èªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        window.onload = () => changeLanguage('ja', document.querySelector('.lang-btn.active'));
    </script>
</body>
</html>
