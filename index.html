<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self Check-in</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .step-active { background-color: #667eea !important; color: white !important; }
        .hidden { display: none !important; }
        video, img#preview {
            width: 100%;
            border-radius: 12px;
            transform: scaleX(1); /* é¡åƒã«ã™ã‚‹å ´åˆã¯ -1 */
        }
    </style>
</head>
<body class="p-4 md:p-8 font-sans antialiased text-slate-800">

    <div class="max-w-md mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-center text-white">
            <h1 id="title" class="text-2xl font-bold">ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h1>
            <p id="subtitle" class="text-indigo-100 text-sm opacity-80 uppercase tracking-widest mt-1">Self Check-in</p>
        </div>

        <!-- Language Selector -->
        <div class="flex flex-wrap justify-center gap-2 p-4 bg-slate-50 border-b border-slate-100">
            <button class="lang-btn px-3 py-1.5 text-xs font-semibold rounded-full border-2 border-slate-200 bg-white transition-all active" onclick="changeLanguage('ja', this)">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
            <button class="lang-btn px-3 py-1.5 text-xs font-semibold rounded-full border-2 border-slate-200 bg-white transition-all" onclick="changeLanguage('en', this)">ğŸ‡¬ğŸ‡§ English</button>
            <button class="lang-btn px-3 py-1.5 text-xs font-semibold rounded-full border-2 border-slate-200 bg-white transition-all" onclick="changeLanguage('zh', this)">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
            <button class="lang-btn px-3 py-1.5 text-xs font-semibold rounded-full border-2 border-slate-200 bg-white transition-all" onclick="changeLanguage('ko', this)">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
            <button class="lang-btn px-3 py-1.5 text-xs font-semibold rounded-full border-2 border-slate-200 bg-white transition-all" onclick="changeLanguage('vi', this)">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
        </div>

        <!-- Content Area -->
        <div class="p-6 md:p-8" id="mainContent">
            <!-- Step Indicator -->
            <div class="relative flex justify-between mb-8 px-2">
                <div class="absolute top-1/2 left-0 w-full h-0.5 bg-slate-100 -translate-y-1/2 z-0"></div>
                <div id="step1" class="step-active z-10 w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-sm transition-colors">1</div>
                <div id="step2" class="z-10 w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-sm transition-colors">2</div>
                <div id="step3" class="z-10 w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-sm transition-colors">3</div>
            </div>

            <form id="checkinForm" onsubmit="return false;" class="space-y-5">
                <!-- STEP 1 -->
                <div id="stepContent1" class="space-y-4">
                    <div>
                        <label id="labelName" class="block text-sm font-bold mb-1 text-slate-700">ãŠåå‰ <span class="text-red-500">*</span></label>
                        <input type="text" id="name" placeholder="Yamada Taro" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-0 outline-none transition-all">
                        <p class="error hidden text-red-500 text-xs mt-1 font-bold" id="errorName"></p>
                    </div>
                    <div>
                        <label id="labelNationality" class="block text-sm font-bold mb-1 text-slate-700">å›½ç± <span class="text-red-500">*</span></label>
                        <input type="text" id="nationality" placeholder="Japan" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-0 outline-none transition-all">
                        <p class="error hidden text-red-500 text-xs mt-1 font-bold" id="errorNationality"></p>
                    </div>
                    <div>
                        <label id="labelBirthdate" class="block text-sm font-bold mb-1 text-slate-700">ç”Ÿå¹´æœˆæ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="birthdate" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-0 outline-none transition-all">
                        <p class="error hidden text-red-500 text-xs mt-1 font-bold" id="errorBirthdate"></p>
                    </div>
                </div>

                <!-- STEP 2 -->
                <div id="stepContent2" class="hidden space-y-4">
                    <div>
                        <label id="labelNights" class="block text-sm font-bold mb-1 text-slate-700">å®¿æ³Šæ•° <span class="text-red-500">*</span></label>
                        <input type="number" id="nights" value="1" min="1" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-0 outline-none transition-all">
                    </div>
                    <div>
                        <label id="labelPhone" class="block text-sm font-bold mb-1 text-slate-700">é›»è©±ç•ªå· <span class="text-red-500">*</span></label>
                        <input type="tel" id="phone" placeholder="09012345678" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-0 outline-none transition-all">
                        <p class="error hidden text-red-500 text-xs mt-1 font-bold" id="errorPhone"></p>
                    </div>
                    <div>
                        <label id="labelAddress" class="block text-sm font-bold mb-1 text-slate-700">ä½æ‰€ <span class="text-red-500">*</span></label>
                        <input type="text" id="address" placeholder="Tokyo, Shibuya..." class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-0 outline-none transition-all">
                        <p class="error hidden text-red-500 text-xs mt-1 font-bold" id="errorAddress"></p>
                    </div>
                </div>

                <!-- STEP 3 -->
                <div id="stepContent3" class="hidden space-y-4">
                    <div id="foreignFields">
                        <div class="p-3 bg-amber-50 border-l-4 border-amber-400 text-amber-800 text-xs rounded mb-4" id="noteId">
                            å¤–å›½ç±ã®æ–¹ã¯ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç­‰ã®æ’®å½±ãŒå¿…è¦ã§ã™ã€‚
                        </div>
                        <div>
                            <label id="labelDocType" class="block text-sm font-bold mb-1 text-slate-700">è¨¼æ˜æ›¸ã®ç¨®é¡</label>
                            <select id="documentType" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl outline-none">
                                <option value="Passport">Passport</option>
                                <option value="Residence Card">Residence Card</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mt-4">
                            <label id="labelPassport" class="block text-sm font-bold mb-1 text-slate-700">ç•ªå· <span class="text-red-500">*</span></label>
                            <input type="text" id="passportNumber" placeholder="AB1234567" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none transition-all">
                            <p class="error hidden text-red-500 text-xs mt-1 font-bold" id="errorPassport"></p>
                        </div>
                        <div class="mt-4">
                            <label id="labelPhoto" class="block text-sm font-bold mb-2 text-slate-700 font-bold text-center underline">èº«åˆ†è¨¼ã®å†™çœŸ</label>
                            
                            <div class="grid grid-cols-2 gap-3" id="cameraButtons">
                                <button type="button" onclick="startCamera()" class="p-4 border-2 border-dashed border-indigo-300 bg-indigo-50 text-indigo-600 rounded-xl flex flex-col items-center justify-center hover:bg-indigo-100 transition-colors">
                                    <span class="text-2xl mb-1">ğŸ“·</span>
                                    <span id="btnCamera" class="text-xs font-bold uppercase">Camera</span>
                                </button>
                                <button type="button" onclick="document.getElementById('fileInput').click()" class="p-4 border-2 border-dashed border-indigo-300 bg-indigo-50 text-indigo-600 rounded-xl flex flex-col items-center justify-center hover:bg-indigo-100 transition-colors">
                                    <span class="text-2xl mb-1">ğŸ“</span>
                                    <span id="btnFile" class="text-xs font-bold uppercase">File</span>
                                </button>
                            </div>

                            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                            <div class="relative mt-2">
                                <video id="video" class="hidden bg-black" autoplay playsinline></video>
                                <canvas id="captureCanvas" class="hidden"></canvas>
                                <button type="button" id="captureBtn" onclick="capturePhoto()" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-white text-indigo-600 p-3 rounded-full shadow-lg font-bold border-2 border-indigo-600 hover:bg-indigo-50">
                                    CAPTURE
                                </button>
                            </div>
                            <img id="preview" class="hidden mt-2 border-2 border-indigo-100 shadow-sm" alt="Preview">
                            <button type="button" id="retakeBtn" onclick="retakePhoto()" class="hidden w-full mt-2 text-indigo-600 font-bold text-sm py-2 hover:bg-slate-50 rounded-lg">
                                ğŸ”„ <span id="btnRetake">Retake</span>
                            </button>
                            <p class="error hidden text-red-500 text-xs mt-1 font-bold" id="errorPhoto"></p>
                        </div>
                    </div>
                    <div id="japaneseNote" class="hidden p-4 bg-emerald-50 border-l-4 border-emerald-400 text-emerald-800 text-sm rounded">
                        âœ… <span id="noteJp">æ—¥æœ¬äººã®æ–¹ã¯å†™çœŸæ’®å½±ä¸è¦ã§ã™ã€‚ã€Œå®Œäº†ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex gap-3 pt-6">
                    <button type="button" id="backBtn" onclick="previousStep()" class="hidden flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-all">
                        â† <span id="btnBack">Back</span>
                    </button>
                    <button type="button" id="nextBtn" onclick="nextStep()" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 active:scale-95 transition-all">
                        <span id="btnNext">Next</span> â†’
                    </button>
                    <button type="button" id="submitBtn" onclick="submitForm()" class="hidden flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-200 active:scale-95 transition-all">
                        âœ“ <span id="btnSubmit">Finish</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Success Screen -->
        <div id="successScreen" class="hidden p-12 text-center space-y-4">
            <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto text-4xl">âœ“</div>
            <h2 class="text-2xl font-extrabold text-slate-800">Thank you!</h2>
            <p id="successMsg" class="text-slate-500 leading-relaxed">
                ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>
                1.5ç§’å¾Œã«æ¬¡ã¸é€²ã¿ã¾ã™...
            </p>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxqqDedpsTIbGdtXhVouI4se9ZsV07gR19onY1UjbDBHPE7ODEW_R_5zqBuMHgxZs2x/exec';
        const NEXT_PAGE_URL = 'https://script.google.com/macros/s/AKfycbwxIJmU0kZMeMhaUcp2QsCLHv74Eujg-c9H1vBKvDEgwZd_Tri4mb-hJcb69fDrID_-Sw/exec';

        const translations = {
            ja: { title: 'ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³', labelName: 'ãŠåå‰', labelNationality: 'å›½ç±', labelBirthdate: 'ç”Ÿå¹´æœˆæ—¥', labelNights: 'å®¿æ³Šæ•°', labelPhone: 'é›»è©±ç•ªå·', labelAddress: 'ä½æ‰€', labelDocType: 'è¨¼æ˜æ›¸ã®ç¨®é¡', labelPassport: 'ç•ªå·', labelPhoto: 'èº«åˆ†è¨¼ã®å†™çœŸ', btnNext: 'æ¬¡ã¸', btnBack: 'æˆ»ã‚‹', btnSubmit: 'å®Œäº†', btnRetake: 'æ’®ã‚Šç›´ã—', required: 'å¿…é ˆé …ç›®ã§ã™', noteId: 'å¤–å›½ç±ã®æ–¹ã¯èº«åˆ†è¨¼ã®æ’®å½±ãŒå¿…è¦ã§ã™ã€‚', noteJp: 'æ—¥æœ¬äººã®æ–¹ã¯å†™çœŸæ’®å½±ä¸è¦ã§ã™ã€‚ãã®ã¾ã¾å®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', btnCamera: 'ã‚«ãƒ¡ãƒ©', btnFile: 'ãƒ•ã‚¡ã‚¤ãƒ«' },
            en: { title: 'Self Check-in', labelName: 'Full Name', labelNationality: 'Nationality', labelBirthdate: 'Birthdate', labelNights: 'Nights', labelPhone: 'Phone Number', labelAddress: 'Address', labelDocType: 'Doc Type', labelPassport: 'ID Number', labelPhoto: 'ID Photo', btnNext: 'Next', btnBack: 'Back', btnSubmit: 'Finish', btnRetake: 'Retake', required: 'Required', noteId: 'Non-Japanese guests: Please provide ID photo.', noteJp: 'Japanese citizens do not need an ID photo. Click Finish.', btnCamera: 'Camera', btnFile: 'File' },
            zh: { title: 'è‡ªåŠ©å…¥ä½', labelName: 'å§“å', labelNationality: 'å›½ç±', labelBirthdate: 'å‡ºç”Ÿæ—¥æœŸ', labelNights: 'æ™šæ•°', labelPhone: 'é›»è©±', labelAddress: 'åœ°å€', labelDocType: 'è¯ä»¶ç±»å‹', labelPassport: 'è¯ä»¶å·', labelPhoto: 'è¯ä»¶ç…§', btnNext: 'ä¸‹ä¸€æ­¥', btnBack: 'è¿”å›', btnSubmit: 'å®Œæˆ', btnRetake: 'é‡æ‹', required: 'å¿…å¡«', noteId: 'å¤–å›½ç±æ—…å®¢éœ€è¦æ‹æ‘„è¯ä»¶ã€‚', noteJp: 'æ—¥æœ¬ç±æ—…å®¢æ— éœ€æ‹æ‘„ã€‚ç›´æ¥ç‚¹å‡»å®Œæˆã€‚', btnCamera: 'ç›¸æœº', btnFile: 'æ–‡ä»¶' },
            ko: { title: 'ì…€í”„ ì²´í¬ì¸', labelName: 'ì„±í•¨', labelNationality: 'êµ­ì ', labelBirthdate: 'ìƒë…„ì›”ì¼', labelNights: 'ìˆ™ë°• ì¼ìˆ˜', labelPhone: 'ì „í™”ë²ˆí˜¸', labelAddress: 'ì£¼ì†Œ', labelDocType: 'ì‹ ë¶„ì¦ ì¢…ë¥˜', labelPassport: 'ë²ˆí˜¸', labelPhoto: 'ì‹ ë¶„ì¦ ì‚¬ì§„', btnNext: 'ë‹¤ìŒ', btnBack: 'ì´ì „', btnSubmit: 'ì™„ë£Œ', btnRetake: 'ë‹¤ì‹œ ì°ê¸°', required: 'í•„ìˆ˜', noteId: 'ì™¸êµ­ì¸ ê³ ê°ì€ ì‹ ë¶„ì¦ ì´¬ì˜ì´ í•„ìš”í•©ë‹ˆë‹¤.', noteJp: 'ì¼ë³¸ì¸ ê³ ê°ì€ ì´¬ì˜ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤. ì™„ë£Œë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.', btnCamera: 'ì¹´ë©”ë¼', btnFile: 'íŒŒì¼' },
            vi: { title: 'Tá»± check-in', labelName: 'Há» vÃ  tÃªn', labelNationality: 'Quá»‘c tá»‹ch', labelBirthdate: 'NgÃ y sinh', labelNights: 'Sá»‘ Ä‘Ãªm', labelPhone: 'Sá»‘ Ä‘iá»‡n thoáº¡i', labelAddress: 'Äá»‹a chá»‰', labelDocType: 'Giáº¥y tá»', labelPassport: 'Sá»‘ ID', labelPhoto: 'áº¢nh ID', btnNext: 'Tiáº¿p theo', btnBack: 'Quay láº¡i', btnSubmit: 'HoÃ n táº¥t', btnRetake: 'Chá»¥p láº¡i', required: 'Báº¯t buá»™c', noteId: 'KhÃ¡ch nÆ°á»›c ngoÃ i cáº§n chá»¥p áº£nh ID.', noteJp: 'KhÃ¡ch Nháº­t khÃ´ng cáº§n chá»¥p áº£nh. Nháº¥n HoÃ n táº¥t.', btnCamera: 'MÃ¡y áº£nh', btnFile: 'Tá»‡p' }
        };

        let currentStep = 1;
        let currentLanguage = 'ja';
        let capturedImage = null;
        let videoStream = null;

        function changeLanguage(lang, btn) {
            currentLanguage = lang;
            const t = translations[lang];
            document.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'bg-indigo-50');
                b.classList.add('border-slate-200', 'text-slate-600');
            });
            btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'bg-indigo-50');

            document.getElementById('title').textContent = t.title;
            const targetIds = ['labelName', 'labelNationality', 'labelBirthdate', 'labelNights', 'labelPhone', 'labelAddress', 'labelDocType', 'labelPassport', 'labelPhoto', 'btnNext', 'btnBack', 'btnSubmit', 'btnRetake', 'noteId', 'noteJp', 'btnCamera', 'btnFile'];
            
            targetIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id.startsWith('label') && t[id].includes(' ')) {
                        el.innerHTML = `${t[id]} <span class="text-red-500">*</span>`;
                    } else if (id.startsWith('label')) {
                        el.innerHTML = `${t[id]} <span class="text-red-500">*</span>`;
                    } else {
                        el.textContent = t[id];
                    }
                }
            });
        }

        function isJapanese() {
            const val = document.getElementById('nationality').value.toLowerCase().trim();
            const jpList = ['æ—¥æœ¬', 'japan', 'ì¼ë³¸', 'nháº­t báº£n', 'ã«ã»ã‚“', 'ã«ã£ã½ã‚“', 'jp', 'japanese', 'nhat ban'];
            return jpList.includes(val);
        }

        function updateStepDisplay() {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).classList.toggle('step-active', i <= currentStep);
                document.getElementById(`stepContent${i}`).classList.toggle('hidden', i !== currentStep);
            }
            document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 3);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== 3);

            if (currentStep === 3) {
                const jp = isJapanese();
                document.getElementById('foreignFields').classList.toggle('hidden', jp);
                document.getElementById('japaneseNote').classList.toggle('hidden', !jp);
            }
        }

        function validateStep() {
            const t = translations[currentLanguage];
            document.querySelectorAll('.error').forEach(e => e.classList.add('hidden'));
            let valid = true;

            const check = (id, errorId) => {
                const el = document.getElementById(id);
                if (!el.value.trim()) {
                    showError(errorId, t.required);
                    valid = false;
                }
            };

            if (currentStep === 1) {
                check('name', 'errorName');
                check('nationality', 'errorNationality');
                check('birthdate', 'errorBirthdate');
            } else if (currentStep === 2) {
                check('phone', 'errorPhone');
                check('address', 'errorAddress');
            } else if (currentStep === 3 && !isJapanese()) {
                check('passportNumber', 'errorPassport');
                if (!capturedImage) {
                    showError('errorPhoto', t.required);
                    valid = false;
                }
            }
            return valid;
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function nextStep() {
            if (validateStep()) {
                currentStep++;
                updateStepDisplay();
            }
        }

        function previousStep() {
            currentStep--;
            updateStepDisplay();
        }

        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                video.classList.remove('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
                document.getElementById('cameraButtons').classList.add('hidden');
                document.getElementById('errorPhoto').classList.add('hidden');
            } catch (err) {
                alert('Camera Access Denied or Not Available.');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('captureCanvas');
            const scale = 800 / Math.max(video.videoWidth, video.videoHeight);
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            capturedImage = canvas.toDataURL('image/jpeg', 0.7);
            
            document.getElementById('preview').src = capturedImage;
            document.getElementById('preview').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            video.classList.add('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            
            if (videoStream) {
                videoStream.getTracks().forEach(t => t.stop());
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    capturedImage = event.target.result;
                    document.getElementById('preview').src = capturedImage;
                    document.getElementById('preview').classList.remove('hidden');
                    document.getElementById('retakeBtn').classList.remove('hidden');
                    document.getElementById('cameraButtons').classList.add('hidden');
                    document.getElementById('errorPhoto').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function retakePhoto() {
            capturedImage = null;
            document.getElementById('preview').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('cameraButtons').classList.remove('hidden');
            document.getElementById('fileInput').value = "";
            document.getElementById('video').classList.add('hidden');
        }

        async function submitForm() {
            if (!validateStep()) return;
            
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Processing...</span>';

            // --- å¹´é½¢ã®è‡ªå‹•è¨ˆç®— ---
            const birthValue = document.getElementById('birthdate').value;
            const birthDate = new Date(birthValue);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            const payload = {
                name: document.getElementById('name').value,
                nationality: document.getElementById('nationality').value,
                birthdate: birthValue,
                age: age, // è‡ªå‹•è¨ˆç®—ã—ãŸå¹´é½¢ã‚’è¿½åŠ 
                nights: document.getElementById('nights').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                documentType: document.getElementById('documentType').value,
                passportNumber: document.getElementById('passportNumber').value,
                documentImage: capturedImage,
                language: currentLanguage,
                timestamp: new Date().toISOString()
            };

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('successScreen').classList.remove('hidden');

                setTimeout(() => {
                    window.location.href = `${NEXT_PAGE_URL}?name=${encodeURIComponent(payload.name)}`;
                }, 1500);

            } catch (err) {
                console.error(err);
                alert('Submit Error. Please check connection.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        window.onload = () => changeLanguage('ja', document.querySelector('.lang-btn.active'));
    </script>
</body>
</html>
